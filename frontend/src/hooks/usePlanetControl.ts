import { useState, useEffect, useRef } from 'react';
import { NormalizedLandmarkList } from '@mediapipe/hands';
import { HandData, PlanetControlState, PlanetType } from '../types';
import { processGestureControl, GestureControlInput } from '../services/gestureController';
import { getNextPlanet, getPreviousPlanet } from '../data/planets';
import { landmarkToPoint } from '../utils/mathUtils';

const LANDMARKS = {
  INDEX_TIP: 8,
  WRIST: 0,
} as const;

interface UsePlanetControlProps {
  handData: HandData | null;
  landmarks: NormalizedLandmarkList[];
}

const INITIAL_STATE: PlanetControlState = {
  zoom: 1.0,
  rotationX: 0,
  rotationY: 0,
  rotationZ: 0,
  currentPlanet: 'SATURN',
};

export function usePlanetControl({ handData, landmarks }: UsePlanetControlProps) {
  const [controlState, setControlState] = useState<PlanetControlState>(INITIAL_STATE);
  
  // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è currentPlanet
  useEffect(() => {
    console.log('üì° usePlanetControl: controlState.currentPlanet =', controlState.currentPlanet);
  }, [controlState.currentPlanet]);
  
  // –•—Ä–∞–Ω–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–µ–ª—å—Ç
  const previousIndexTipRef = useRef<{ x: number; y: number; z: number } | undefined>(undefined);
  const previousOrientationRef = useRef<{ heading: number; pitch: number; roll: number } | undefined>(undefined);
  const previousWristRef = useRef<{ x: number; y: number; z: number } | undefined>(undefined);
  const previousTimestampRef = useRef<number | undefined>(undefined);
  const lastSwipeTimeRef = useRef<number>(0);
  const SWIPE_COOLDOWN = 150; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É swipe (–º—Å) - —É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏

  useEffect(() => {
    if (!handData || landmarks.length === 0) {
      // –ù–µ—Ç —Ä—É–∫–∏ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      previousIndexTipRef.current = undefined;
      previousOrientationRef.current = undefined;
      previousWristRef.current = undefined;
      previousTimestampRef.current = undefined;
      return;
    }

    const currentTimestamp = Date.now();
    const mainHandLandmarks = landmarks[0];
    const indexTip = landmarkToPoint(mainHandLandmarks[LANDMARKS.INDEX_TIP]);
    const wrist = landmarkToPoint(mainHandLandmarks[LANDMARKS.WRIST]);

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è gestureController
    const input: GestureControlInput = {
      landmarks: mainHandLandmarks,
      orientation: handData.orientation,
      pinch: handData.pinch,
      fingerExtension: handData.fingerExtension,
      previousIndexTip: previousIndexTipRef.current,
      previousOrientation: previousOrientationRef.current,
      previousWrist: previousWristRef.current,
    };

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∂–µ—Å—Ç—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
    setControlState((prev) => {
      const output = processGestureControl(
        input,
        prev,
        currentTimestamp,
        previousTimestampRef.current
      );

      // –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ –≤—Ä–∞—â–µ–Ω–∏—è
      const newRotationX = prev.rotationX + output.rotationX;
      const newRotationY = prev.rotationY + output.rotationY;
      const newRotationZ = prev.rotationZ + output.rotationZ;
      
      const newState: PlanetControlState = {
        zoom: output.zoom,
        rotationX: newRotationX,
        rotationY: newRotationY,
        rotationZ: newRotationZ,
        currentPlanet: prev.currentPlanet, // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–ª–∞–Ω–µ—Ç—ã
      };
      
      console.log('üîÑ usePlanetControl setState called:', {
        prevPlanet: prev.currentPlanet,
        newStatePlanet: newState.currentPlanet,
        swipeDirection: output.swipe.direction,
        swipeVelocity: output.swipe.velocity,
      });

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º swipe –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–ø—É—Ç–Ω–∏–∫–æ–≤
      // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ª—é–±–æ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–º —Å–≤–∞–π–ø–µ
      const hasSwipe = output.swipe.direction !== 'none';
      const hasVelocity = output.swipe.velocity > 0.005; // –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
      
      // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Å–≤–∞–π–ø—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      if (hasSwipe) {
        console.log('üîç Swipe detected:', {
          direction: output.swipe.direction,
          velocity: output.swipe.velocity,
          hasVelocity,
        });
      }
      
      // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –ø–ª–∞–Ω–µ—Ç—É –ø—Ä–∏ –ª—é–±–æ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–º —Å–≤–∞–π–ø–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
      if (hasSwipe && hasVelocity) {
        const now = Date.now();
        const timeSinceLastSwipe = now - lastSwipeTimeRef.current;
        
        if (timeSinceLastSwipe > SWIPE_COOLDOWN) {
          lastSwipeTimeRef.current = now;
          
          console.log('‚úÖ Planet switch triggered:', {
            direction: output.swipe.direction,
            velocity: output.swipe.velocity,
            from: prev.currentPlanet,
            timeSinceLastSwipe,
          });
          
          if (output.swipe.direction === 'right') {
            const nextPlanet = getNextPlanet(prev.currentPlanet);
            newState.currentPlanet = nextPlanet;
            console.log('‚Üí Next planet:', nextPlanet, 'from', prev.currentPlanet);
          } else if (output.swipe.direction === 'left') {
            const prevPlanet = getPreviousPlanet(prev.currentPlanet);
            newState.currentPlanet = prevPlanet;
            console.log('‚Üê Previous planet:', prevPlanet, 'from', prev.currentPlanet);
          }
          
          // –õ–æ–≥–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          console.log('üìä New controlState.currentPlanet:', newState.currentPlanet);
          console.log('üì¶ Returning newState with planet:', newState.currentPlanet);
        } else {
          console.log('‚è±Ô∏è Swipe cooldown active:', {
            timeSinceLastSwipe,
            cooldown: SWIPE_COOLDOWN,
            remaining: SWIPE_COOLDOWN - timeSinceLastSwipe,
          });
        }
      } else if (hasSwipe && !hasVelocity) {
        console.log('‚ö†Ô∏è Swipe detected but velocity too low:', {
          direction: output.swipe.direction,
          velocity: output.swipe.velocity,
          threshold: 0.005,
        });
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–∞–¥—Ä–∞
      previousIndexTipRef.current = indexTip;
      previousOrientationRef.current = {
        heading: handData.orientation.heading,
        pitch: handData.orientation.pitch,
        roll: handData.orientation.roll,
      };
      previousWristRef.current = wrist;
      previousTimestampRef.current = currentTimestamp;

      console.log('‚úÖ Returning state from setControlState:', {
        planet: newState.currentPlanet,
        zoom: newState.zoom,
        rotationX: newState.rotationX,
      });

      return newState;
    });
  }, [handData, landmarks]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Ä–∞—â–µ–Ω–∏—è (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏)
  const resetRotation = () => {
    setControlState((prev) => ({
      ...prev,
      rotationX: 0,
      rotationY: 0,
      rotationZ: 0,
    }));
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–ª–∞–Ω–µ—Ç—ã
  const setPlanet = (planet: PlanetType) => {
    setControlState((prev) => ({
      ...prev,
      currentPlanet: planet,
    }));
  };

  return {
    controlState,
    resetRotation,
    setPlanet,
  };
}

